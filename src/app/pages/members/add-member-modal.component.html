<ion-header [translucent]="false">
  <ion-toolbar>
    <ion-title>Add New Member</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onCancel()">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding add-member-content">
  <form class="add-member-form" [formGroup]="memberForm" (ngSubmit)="onSave()">
    <!-- Section 1: Assignment Details -->
    <div class="section-card">
      <div class="section-title">Assignment Details</div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('centerId')">
          <ion-label position="stacked">Center <span class="required">*</span></ion-label>
          <ion-select formControlName="centerId" interface="popover" placeholder="Select Center">
            <ion-select-option [value]="''">Select Center</ion-select-option>
            <ion-select-option *ngFor="let center of centers" [value]="center.id">{{ center.name }}</ion-select-option>
          </ion-select>
          <ion-note slot="error">{{ getFieldError('centerId') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('pocId')">
          <ion-label position="stacked">POC (Point of Contact) <span class="required">*</span></ion-label>
          <ion-select formControlName="pocId" interface="popover" placeholder="Select POC" [disabled]="pocs.length === 0">
            <ion-select-option [value]="''">Select POC</ion-select-option>
            <ion-select-option *ngFor="let poc of pocs" [value]="poc.id">{{ poc.name }}</ion-select-option>
          </ion-select>
          <ion-note slot="error">{{ getFieldError('pocId') }}</ion-note>
        </ion-item>
      </div>
    </div>

    <!-- Section 2: Member Personal Details -->
    <div class="section-card section-card--alt">
      <div class="section-title">Member Personal Details</div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('firstName')">
          <ion-label position="stacked">First Name <span class="required">*</span></ion-label>
          <ion-input formControlName="firstName" placeholder="Enter first name" type="text" maxlength="50"></ion-input>
          <ion-note slot="error">{{ getFieldError('firstName') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('middleName')">
          <ion-label position="stacked">Middle Name</ion-label>
          <ion-input formControlName="middleName" placeholder="Enter middle name" type="text" maxlength="50"></ion-input>
          <ion-note slot="error">{{ getFieldError('middleName') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('lastName')">
          <ion-label position="stacked">Last Name <span class="required">*</span></ion-label>
          <ion-input formControlName="lastName" placeholder="Enter last name" type="text" maxlength="50"></ion-input>
          <ion-note slot="error">{{ getFieldError('lastName') }}</ion-note>
        </ion-item>
      </div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('dateOfBirth')">
          <ion-label position="stacked">Date of Birth <span class="required">*</span></ion-label>
          <ion-input formControlName="dateOfBirth" type="date" [max]="todayString"></ion-input>
          <ion-note slot="error">{{ getFieldError('dateOfBirth') }}</ion-note>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Age</ion-label>
          <ion-input formControlName="age" type="text" readonly placeholder="Auto-calculated"></ion-input>
          <ion-note slot="error">{{ getFieldError('age') }}</ion-note>
        </ion-item>
      </div>
    </div>

    <!-- Section 3: Contact & Address Details -->
    <div class="section-card">
      <div class="section-title">Contact & Address Details</div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('phoneNumber')">
          <ion-label position="stacked">Phone Number <span class="required">*</span></ion-label>
          <ion-input formControlName="phoneNumber" placeholder="Enter phone number" type="tel" maxlength="10" inputmode="numeric"></ion-input>
          <ion-note slot="error">{{ getFieldError('phoneNumber') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('altPhone')">
          <ion-label position="stacked">Alternate Phone</ion-label>
          <ion-input formControlName="altPhone" placeholder="Enter alternate phone" type="tel" maxlength="10" inputmode="numeric"></ion-input>
          <ion-note slot="error">{{ getFieldError('altPhone') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('address1')">
          <ion-label position="stacked">Address Line 1 <span class="required">*</span></ion-label>
          <ion-input formControlName="address1" placeholder="Enter address line 1" type="text" maxlength="200"></ion-input>
          <ion-note slot="error">{{ getFieldError('address1') }}</ion-note>
        </ion-item>
      </div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('address2')">
          <ion-label position="stacked">Address Line 2</ion-label>
          <ion-input formControlName="address2" placeholder="Enter address line 2" type="text" maxlength="200"></ion-input>
          <ion-note slot="error">{{ getFieldError('address2') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('city')">
          <ion-label position="stacked">City <span class="required">*</span></ion-label>
          <ion-input formControlName="city" placeholder="Enter city" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('city') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('state')">
          <ion-label position="stacked">State <span class="required">*</span></ion-label>
          <ion-input formControlName="state" placeholder="Enter state" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('state') }}</ion-note>
        </ion-item>
      </div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('zipCode')">
          <ion-label position="stacked">Zip Code <span class="required">*</span></ion-label>
          <ion-input formControlName="zipCode" placeholder="Enter 6-digit zip code" type="tel" maxlength="6" inputmode="numeric"></ion-input>
          <ion-note slot="error">{{ getFieldError('zipCode') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('aadhaar')">
          <ion-label position="stacked">Aadhaar</ion-label>
          <ion-input formControlName="aadhaar" placeholder="Enter Aadhaar" type="tel" maxlength="12" inputmode="numeric"></ion-input>
          <ion-note slot="error">{{ getFieldError('aadhaar') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('occupation')">
          <ion-label position="stacked">Occupation <span class="required">*</span></ion-label>
          <ion-input formControlName="occupation" placeholder="Enter occupation" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('occupation') }}</ion-note>
        </ion-item>
      </div>
    </div>

    <!-- Section 4: Guardian Details -->
    <div class="section-card section-card--alt">
      <div class="section-title">Guardian Details</div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianFirstName')">
          <ion-label position="stacked">First Name <span class="required">*</span></ion-label>
          <ion-input formControlName="guardianFirstName" placeholder="Enter first name" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianFirstName') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianMiddleName')">
          <ion-label position="stacked">Middle Name</ion-label>
          <ion-input formControlName="guardianMiddleName" placeholder="Enter middle name" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianMiddleName') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianLastName')">
          <ion-label position="stacked">Last Name <span class="required">*</span></ion-label>
          <ion-input formControlName="guardianLastName" placeholder="Enter last name" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianLastName') }}</ion-note>
        </ion-item>
      </div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianRelationship')">
          <ion-label position="stacked">Relationship <span class="required">*</span></ion-label>
          <ion-select formControlName="guardianRelationship" interface="popover" placeholder="Select relationship">
            <ion-select-option value="">Select relationship</ion-select-option>
            <ion-select-option *ngFor="let rel of guardianRelationships" [value]="rel">{{ rel }}</ion-select-option>
          </ion-select>
          <ion-note slot="error">{{ getFieldError('guardianRelationship') }}</ion-note>
        </ion-item>
        <ion-item *ngIf="memberForm.get('guardianRelationship')?.value === 'Other'" [class.ion-invalid]="isFieldInvalid('guardianRelationshipOther')">
          <ion-label position="stacked">Other Relationship <span class="required">*</span></ion-label>
          <ion-input formControlName="guardianRelationshipOther" placeholder="Enter relationship" type="text" maxlength="100"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianRelationshipOther') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianPhone')">
          <ion-label position="stacked">Phone <span class="required">*</span></ion-label>
          <ion-input formControlName="guardianPhone" placeholder="Enter phone number" type="tel" maxlength="10" inputmode="numeric"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianPhone') }}</ion-note>
        </ion-item>
      </div>
      <div class="form-row">
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianDOB')">
          <ion-label position="stacked">DOB</ion-label>
          <ion-input formControlName="guardianDOB" type="date" [max]="todayString"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianDOB') }}</ion-note>
        </ion-item>
        <ion-item [class.ion-invalid]="isFieldInvalid('guardianAge')">
          <ion-label position="stacked">Age <span class="required">*</span></ion-label>
          <ion-input
            formControlName="guardianAge"
            type="number"
            min="18"
            max="150"
            [readonly]="!!memberForm.get('guardianDOB')?.value"
            [placeholder]="memberForm.get('guardianDOB')?.value ? 'Auto-calculated' : '18+'"></ion-input>
          <ion-note slot="error">{{ getFieldError('guardianAge') }}</ion-note>
        </ion-item>
      </div>
    </div>
  </form>
</ion-content>

<ion-footer>
  <ion-toolbar class="footer-toolbar">
    <div class="footer-actions">
      <div class="left-action">
        <ion-button class="save-btn" color="primary" fill="solid" (click)="onSave()" [disabled]="isSubmitting || memberForm.invalid">
          <ion-icon slot="start" name="checkmark-outline"></ion-icon>
          <span class="btn-text">Save Member</span>
        </ion-button>
      </div>
      <div class="right-actions">
        <ion-button type="button" fill="outline" (click)="onClear()" [disabled]="isSubmitting" class="cancel-btn">Clear</ion-button>
        <ion-button type="button" fill="outline" (click)="onCancel()" class="cancel-btn">Cancel</ion-button>
      </div>
    </div>
  </ion-toolbar>
</ion-footer>

<div *ngIf="isLoading" class="loading-overlay">
  <ion-spinner name="crescent"></ion-spinner>
  <p>Loading data...</p>
</div>
