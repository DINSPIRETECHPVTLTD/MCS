<ion-header [translucent]="false">
  <!-- Organization Header -->
  <div class="org-header">
    <div class="org-info">
      <h2 class="org-name">{{ organization?.name || 'Navya Micro Credit Services' }}</h2>
      <p class="org-details" *ngIf="organization">
        <span *ngIf="organization.phone">{{ organization.phone }}</span>
        <span *ngIf="organization.city && organization.phone"> â€¢ </span>
        <span *ngIf="organization.city">{{ organization.city }}</span>
      </p>
    </div>
    <div class="user-section">
      <!-- Branch Dropdown (if multiple branches and Org Owner) -->
      <div class="branch-section" *ngIf="branches.length > 1 && isOrgOwner">
        <div class="branch-dropdown" (click)="toggleBranchDropdown()">
          <ion-icon name="business-outline" class="branch-icon"></ion-icon>
          <span class="branch-name">{{ selectedBranch?.name || 'Select Branch' }}</span>
          <ion-icon name="chevron-down-outline" class="dropdown-icon"></ion-icon>
        </div>
        <div class="branch-dropdown-menu" *ngIf="showBranchDropdown">
          <button 
            class="branch-item" 
            *ngFor="let branch of branches"
            [class.active]="selectedBranch?.id === branch.id"
            (click)="selectBranch(branch)">
            {{ branch.name }}
          </button>
        </div>
      </div>
      
      <!-- Branch Label (if single branch OR branch level user) -->
      <div class="branch-label" *ngIf="(branches.length === 1 || isBranchUser) && selectedBranch">
        <ion-icon name="business-outline" class="branch-icon"></ion-icon>
        <span class="branch-name">{{ selectedBranch.name }}</span>
      </div>

      <div class="user-info">
        <ion-icon name="person-circle-outline" class="user-icon"></ion-icon>
        <span class="user-email">{{ userEmail || 'owner@demo.com' }}</span>
        <ion-icon name="chevron-down-outline" class="dropdown-icon"></ion-icon>
      </div>
      <ion-button fill="clear" class="logout-btn" (click)="logout()">
        <ion-icon name="log-out-outline" slot="start"></ion-icon>
        Log Out
      </ion-button>
    </div>
  </div>

  <!-- Navigation Menu -->
  <ion-toolbar class="nav-toolbar">
    <div class="nav-menu">
      <!-- Dashboard - Show for all users -->
      <button 
        *ngIf="isOrgOwner || isBranchUser"
        class="nav-item" 
        [class.active]="activeMenu === 'Dashboard'"
        (click)="selectSubmenu('Dashboard')">
        Dashboard
      </button>
      
      <!-- Organization Info - Only for Org Owner -->
      <button 
        *ngIf="isOrgOwner"
        class="nav-item" 
        [class.active]="activeMenu === 'Info'"
        (click)="setActiveMenu('Info')">
        Organization Info
      </button>
      
      <!-- Users - Only for Org Owner -->
      <div class="nav-item-container" *ngIf="isOrgOwner">
        <button 
          class="nav-item" 
          [class.active]="activeMenu === 'Users' || activeMenu === 'All Users' || activeMenu === 'Approvals'"
          (click)="setActiveMenu('Users')">
          Users
          <ion-icon 
            [name]="showUsersSubmenu ? 'chevron-up-outline' : 'chevron-down-outline'" 
            class="submenu-icon">
          </ion-icon>
        </button>
      </div>
      
      <!-- Branches - Show for all, but different submenus based on role -->
      <div class="nav-item-container">
        <button 
          class="nav-item" 
          [class.active]="activeMenu === 'Branches' || activeMenu === 'Add new branch' || activeMenu === 'Dashboard' || activeMenu === 'Centers' || activeMenu === 'POCs' || activeMenu === 'Staff' || activeMenu === 'Members'"
          (click)="setActiveMenu('Branches')">
          Branches
          <ion-icon 
            *ngIf="isOrgOwner"
            [name]="showBranchesSubmenu ? 'chevron-up-outline' : 'chevron-down-outline'" 
            class="submenu-icon">
          </ion-icon>
        </button>
      </div>
    </div>
  </ion-toolbar>
  
  <!-- Submenu for Users -->
  <div class="submenu-container" *ngIf="showUsersSubmenu">
    <div class="submenu">
      <button 
        class="submenu-item" 
        [class.active]="activeMenu === 'All Users'"
        (click)="selectSubmenu('All Users')">
        All Users
      </button>
      <button 
        class="submenu-item" 
        [class.active]="activeMenu === 'Approvals'"
        (click)="selectSubmenu('Approvals')">
        Approvals
      </button>
    </div>
  </div>
  
  <!-- Submenu for Branches -->
  <div class="submenu-container" *ngIf="showBranchesSubmenu">
    <div class="submenu">
      <!-- Add new branch - Only for Org Owner -->
      <button 
        *ngIf="isOrgOwner"
        class="submenu-item" 
        [class.active]="activeMenu === 'Add new branch'"
        (click)="selectSubmenu('Add new branch')">
        Add new branch
      </button>
      
      <!-- Dashboard - Show for all users -->
      <button 
        *ngIf="isOrgOwner || isBranchUser"
        class="submenu-item" 
        [class.active]="activeMenu === 'Dashboard'"
        (click)="selectSubmenu('Dashboard')">
        Dashboard
      </button>
      
      <!-- Centers - Show for all users -->
      <button 
        *ngIf="isOrgOwner || isBranchUser"
        class="submenu-item" 
        [class.active]="activeMenu === 'Centers'"
        (click)="selectSubmenu('Centers')">
        Centers
      </button>
      
      <!-- POCs - Show for all users -->
      <button 
        *ngIf="isOrgOwner || isBranchUser"
        class="submenu-item" 
        [class.active]="activeMenu === 'POCs'"
        (click)="selectSubmenu('POCs')">
        POCs
      </button>
      
      <!-- Staff - Show for all users -->
      <button 
        *ngIf="isOrgOwner || isBranchUser"
        class="submenu-item" 
        [class.active]="activeMenu === 'Staff'"
        (click)="selectSubmenu('Staff')">
        Staff
      </button>
      
      <!-- Members - Show for all users -->
      <button 
        *ngIf="isOrgOwner || isBranchUser"
        class="submenu-item" 
        [class.active]="activeMenu === 'Members'"
        (click)="selectSubmenu('Members')">
        Members
      </button>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Add User Form -->
  <div class="user-form-container" *ngIf="showAddForm">
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ isEditing ? 'Edit User' : 'Add New User' }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
          <!-- Name Fields -->
          <ion-item>
            <ion-input
              label="First Name"
              labelPlacement="stacked"
              formControlName="firstName"
              placeholder="Enter first name"
              required>
            </ion-input>
          </ion-item>
          <div *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched" class="error-message">
            First name is required
          </div>

          <ion-item>
            <ion-input
              label="Middle Name"
              labelPlacement="stacked"
              formControlName="middleName"
              placeholder="Enter middle name">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="Last Name"
              labelPlacement="stacked"
              formControlName="lastName"
              placeholder="Enter last name"
              required>
            </ion-input>
          </ion-item>
          <div *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched" class="error-message">
            Last name is required
          </div>

          <!-- Contact Fields -->
          <ion-item>
            <ion-input
              label="Phone Number"
              labelPlacement="stacked"
              type="tel"
              formControlName="phoneNumber"
              placeholder="Enter phone number">
            </ion-input>
          </ion-item>
          <div *ngIf="userForm.get('phoneNumber')?.invalid && userForm.get('phoneNumber')?.touched" class="error-message">
            Please enter a valid 10-digit phone number
          </div>

          <ion-item>
            <ion-input
              label="Email"
              labelPlacement="stacked"
              type="email"
              formControlName="email"
              placeholder="Enter email address">
            </ion-input>
          </ion-item>
          <div *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched" class="error-message">
            Please enter a valid email address
          </div>

          <!-- Address Fields -->
          <ion-item>
            <ion-input
              label="Address Line 1"
              labelPlacement="stacked"
              formControlName="address1"
              placeholder="Enter address line 1">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="Address Line 2"
              labelPlacement="stacked"
              formControlName="address2"
              placeholder="Enter address line 2">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="City"
              labelPlacement="stacked"
              formControlName="city"
              placeholder="Enter city">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="State"
              labelPlacement="stacked"
              formControlName="state"
              placeholder="Enter state">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="Pin Code"
              labelPlacement="stacked"
              type="tel"
              formControlName="pinCode"
              placeholder="Enter pin code">
            </ion-input>
          </ion-item>
          <div *ngIf="userForm.get('pinCode')?.invalid && userForm.get('pinCode')?.touched" class="error-message">
            Please enter a valid 6-digit pin code
          </div>

          <!-- Level and Role (Read-only, showing defaults) -->
          <ion-item>
            <ion-input
              label="Level"
              labelPlacement="stacked"
              [value]="userForm.value.level"
              readonly>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="Role"
              labelPlacement="stacked"
              [value]="userForm.value.role"
              readonly>
            </ion-input>
          </ion-item>

          <ion-button
            expand="block"
            type="submit"
            [disabled]="userForm.invalid"
            class="ion-margin-top">
            {{ isEditing ? 'Update User' : 'Create User' }}
          </ion-button>
        </form>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Users List -->
  <div class="users-list-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h2>All Users</h2>
      <ion-button (click)="toggleAddForm()" *ngIf="!showAddForm">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Add User
      </ion-button>
    </div>
    <div *ngIf="users.length === 0" class="empty-state">
      <ion-icon name="people-outline" size="large"></ion-icon>
      <p>No users found</p>
    </div>
    <ion-list *ngIf="users.length > 0">
      <ion-item *ngFor="let user of users" class="user-item">
        <ion-avatar slot="start">
          <ion-icon name="person-circle-outline"></ion-icon>
        </ion-avatar>
        <ion-label>
          <h2>{{ user.firstName }} {{ user.middleName || '' }} {{ user.lastName }}</h2>
          <p *ngIf="user.email">{{ user.email }}</p>
          <p *ngIf="user.phoneNumber">{{ user.phoneNumber }}</p>
          <p *ngIf="user.role">{{ user.role }} - {{ user.level }}</p>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>
</ion-content>
